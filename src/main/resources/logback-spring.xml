<!-- src/main/resources/logback-spring.xml -->
<configuration>
    <!-- env var LOG_DIR or fallback -->
    <property name="LOG_DIR" value="${LOG_DIR:-logs}"/>

    <!-- console -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{reqId} %X{windowCursor} %X{batchNo}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- INFO+ only lines that contain [sync.ops] -->
    <appender name="SYNC_OPS" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/sync-ops.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/sync-ops.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>14</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>

        <!-- keep only ops lines -->
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
                <expression><![CDATA[
          return formattedMessage != null
              && formattedMessage.contains("[sync.ops]")
              && level >= ch.qos.logback.classic.Level.INFO_INT;
        ]]></expression>
            </evaluator>
            <OnMatch>ACCEPT</OnMatch>
            <OnMismatch>DENY</OnMismatch>
        </filter>

        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{reqId} %X{windowCursor} %X{batchNo}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- DEBUG/TRACE -->
    <appender name="SYNC_DEBUG" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/sync-debug.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/sync-debug.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>50MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>7</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>DEBUG</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>NEUTRAL</onMismatch>
        </filter>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>TRACE</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{reqId} %X{windowCursor} %X{batchNo}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- WARN+ но исключаем [sync.mismatch] -->
    <appender name="SYNC_ERRORS" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/sync-errors.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/sync-errors.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>50MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>

        <!-- 1) Сначала отбрасываем строки с [sync.mismatch] -->
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
                <expression><![CDATA[
              return formattedMessage != null && formattedMessage.contains("[sync.mismatch]");
            ]]></expression>
            </evaluator>
            <OnMatch>DENY</OnMatch>
            <OnMismatch>NEUTRAL</OnMismatch>
        </filter>

        <!-- 2) Потом пропускаем только WARN+ -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>WARN</level>
        </filter>

        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{reqId} %X{windowCursor} %X{batchNo}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- только строки, содержащие [sync.mismatch], в отдельный файл -->
    <appender name="SYNC_MISMATCH" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/sync-mismatch.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/sync-mismatch.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>20MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>14</maxHistory>
            <totalSizeCap>512MB</totalSizeCap>
        </rollingPolicy>

        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
                <expression><![CDATA[
                return formattedMessage != null && formattedMessage.contains("[sync.mismatch]");
            ]]></expression>
            </evaluator>
            <OnMatch>ACCEPT</OnMatch>
            <OnMismatch>DENY</OnMismatch>
        </filter>

        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{reqId}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- root to console -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>

    <!-- project package -> console + files -->
    <logger name="org.example.proect.lavka" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="SYNC_OPS"/>
        <appender-ref ref="SYNC_DEBUG"/>
        <appender-ref ref="SYNC_ERRORS"/>
        <appender-ref ref="SYNC_MISMATCH"/>
    </logger>
</configuration>